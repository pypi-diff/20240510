# Comparing `tmp/msanic-1.0.21-py3-none-any.whl.zip` & `tmp/msanic-1.0.22-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,27 +1,27 @@
-Zip file size: 59145 bytes, number of entries: 42
+Zip file size: 59279 bytes, number of entries: 42
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 msanic/__init__.py
 -rw-rw-rw-  2.0 fat     3462 b- defN 24-Apr-15 07:17 msanic/base_blue.py
 -rw-rw-rw-  2.0 fat     8536 b- defN 24-May-05 02:44 msanic/base_conf.py
 -rw-rw-rw-  2.0 fat     3241 b- defN 24-Mar-25 14:10 msanic/base_server.py
--rw-rw-rw-  2.0 fat     9898 b- defN 24-May-08 13:21 msanic/base_ws.py
+-rw-rw-rw-  2.0 fat     9666 b- defN 24-May-10 03:10 msanic/base_ws.py
 -rw-rw-rw-  2.0 fat     2908 b- defN 24-Apr-28 08:44 msanic/exception.py
 -rw-rw-rw-  2.0 fat     7677 b- defN 24-Apr-15 07:12 msanic/handler_http.py
 -rw-rw-rw-  2.0 fat     2727 b- defN 24-May-07 10:22 msanic/handler_ws.py
 -rw-rw-rw-  2.0 fat      576 b- defN 24-Apr-12 02:20 msanic/middleware.py
 -rw-rw-rw-  2.0 fat    10352 b- defN 24-May-05 02:43 msanic/mult_creator.py
 -rw-rw-rw-  2.0 fat     8531 b- defN 24-Mar-21 14:40 msanic/verify.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 msanic/libs/__init__.py
 -rw-rw-rw-  2.0 fat     7656 b- defN 24-Mar-21 14:40 msanic/libs/base_timed.py
 -rw-rw-rw-  2.0 fat     1276 b- defN 24-Apr-12 09:22 msanic/libs/component.py
 -rw-rw-rw-  2.0 fat     3151 b- defN 24-Apr-28 08:45 msanic/libs/consts.py
 -rw-rw-rw-  2.0 fat     1578 b- defN 24-Mar-21 14:40 msanic/libs/crypto.py
 -rw-rw-rw-  2.0 fat     3171 b- defN 24-Mar-21 14:40 msanic/libs/decorator.py
 -rw-rw-rw-  2.0 fat     1125 b- defN 24-Mar-21 14:40 msanic/libs/file_type.py
--rw-rw-rw-  2.0 fat     2235 b- defN 24-May-08 09:19 msanic/libs/manager.py
+-rw-rw-rw-  2.0 fat     2728 b- defN 24-May-10 03:09 msanic/libs/manager.py
 -rw-rw-rw-  2.0 fat     2495 b- defN 24-Mar-21 14:40 msanic/libs/mult_log.py
 -rw-rw-rw-  2.0 fat     5263 b- defN 24-Mar-21 14:40 msanic/libs/random_maker.py
 -rw-rw-rw-  2.0 fat     8453 b- defN 24-Apr-15 07:12 msanic/libs/rds_client.py
 -rw-rw-rw-  2.0 fat     1116 b- defN 24-Apr-03 08:13 msanic/libs/rds_locker.py
 -rw-rw-rw-  2.0 fat     6985 b- defN 24-Apr-28 09:19 msanic/libs/tool.py
 -rw-rw-rw-  2.0 fat     5014 b- defN 24-Mar-25 15:32 msanic/libs/tool_dt.py
 -rw-rw-rw-  2.0 fat     3070 b- defN 24-Mar-21 14:40 msanic/libs/tool_jwt.py
@@ -31,14 +31,14 @@
 -rw-rw-rw-  2.0 fat    18726 b- defN 24-Apr-28 08:44 msanic/orm/db_model.py
 -rw-rw-rw-  2.0 fat    11698 b- defN 24-Apr-03 07:45 msanic/orm/mssql_generator.py
 -rw-rw-rw-  2.0 fat    11743 b- defN 24-Apr-28 08:44 msanic/orm/mysql_generator.py
 -rw-rw-rw-  2.0 fat    11720 b- defN 24-Apr-03 07:45 msanic/orm/pgsql_generator.py
 -rw-rw-rw-  2.0 fat     5098 b- defN 24-Apr-12 02:19 msanic/orm/rc_model.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 test/__init__.py
 -rw-rw-rw-  2.0 fat      701 b- defN 24-May-04 15:15 test/test_unit.py
--rw-rw-rw-  2.0 fat     1090 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/LICENSE
--rw-rw-rw-  2.0 fat     4801 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/WHEEL
--rw-rw-rw-  2.0 fat       52 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/entry_points.txt
--rw-rw-rw-  2.0 fat       12 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/top_level.txt
--rw-rw-r--  2.0 fat     3314 b- defN 24-May-08 13:41 msanic-1.0.21.dist-info/RECORD
-42 files, 182304 bytes uncompressed, 53951 bytes compressed:  70.4%
+-rw-rw-rw-  2.0 fat     1090 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat     4801 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat       52 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/entry_points.txt
+-rw-rw-rw-  2.0 fat       12 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/top_level.txt
+-rw-rw-r--  2.0 fat     3314 b- defN 24-May-10 03:10 msanic-1.0.22.dist-info/RECORD
+42 files, 182565 bytes uncompressed, 54085 bytes compressed:  70.4%
```

## zipnote {}

```diff
@@ -102,26 +102,26 @@
 
 Filename: test/__init__.py
 Comment: 
 
 Filename: test/test_unit.py
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/LICENSE
+Filename: msanic-1.0.22.dist-info/LICENSE
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/METADATA
+Filename: msanic-1.0.22.dist-info/METADATA
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/WHEEL
+Filename: msanic-1.0.22.dist-info/WHEEL
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/entry_points.txt
+Filename: msanic-1.0.22.dist-info/entry_points.txt
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/top_level.txt
+Filename: msanic-1.0.22.dist-info/top_level.txt
 Comment: 
 
-Filename: msanic-1.0.21.dist-info/RECORD
+Filename: msanic-1.0.22.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## msanic/base_ws.py

```diff
@@ -25,14 +25,16 @@
     '''弹回消息标码'''
     max_history_queue = 100
     '''最大历史消息数量'''
 
     def __init__(self):
         self.ws_manager.set_conf(self.conf)
         self.CMD_MAP = {k: v(self.conf, k) for k, v in self.CMD_MAP.items()}
+        for v in self.CMD_MAP.values():
+            self.ws_manager.register_fun(v.__class__.__name__, v.off_line)
         self.fun_pack_msg: callable = tool_ws.pack_msg
         self.fun_parse_msg: callable = tool_ws.parse_msg
 
     @classmethod
     def init_ws(cls):
         return cls()
 
@@ -101,15 +103,15 @@
             if fun and callable(fun.funapi):
                 msg_arr = None
                 try:
                     msg_arr = await fun.funapi(c_code, uinfo, data)
                     await ws.send(self.fun_pack_msg(c_type, *msg_arr, req=extra))
                 except WebsocketClosed:
                     msg_arr and await self.__save_as_history(uinfo, self.fun_pack_msg(c_type, *msg_arr, req=extra))
-                    return await self.on_offline(uinfo)
+                    return await self.ws_manager.call_offline(self.get_ukey(uinfo))
                 except Exception as err:
                     msg_arr and await self.__save_as_history(uinfo, self.fun_pack_msg(c_type, *msg_arr, req=extra))
                     self.log.error(f'{err}:{traceback.format_exc()}')
                     await ws.send(self.fun_pack_msg(
                         c_type, c_code, code=self.conf.STA_CODE.FAIL, req=extra, hint='A error cause failed'))
             else:
                 await ws.send(self.fun_pack_msg(
@@ -173,20 +175,14 @@
         try:
             return await ws.send(self.fun_pack_msg(c_type, c_code,  data=data, code=self.conf.STA_CODE.PASS))
         except Exception as err:
             self.log.info(f'发送目标消息失败,receiver:{receiver},data:{data},错误信息：{err}')
         return await self.__save_as_history(
             receiver, self.fun_pack_msg(c_type, c_code, data=data, code=self.conf.STA_CODE.PASS))
 
-    async def on_offline(self, uinfo):
-        """用户掉线处理逻辑"""
-        ukey = self.get_ukey(uinfo)
-        await self.rds.drop_hash(self.conf.WS_ONLINE_INFO, ukey)
-        await self.ws_manager.close_ws(ukey)
-
     async def check_ws_conn(self, uinfo, req, ws):
         timestamp = req.headers.get('Timestamp') or req.args.get('Timestamp')
         if not timestamp:
             await ws.send(self.fun_pack_msg(
                 self.dft_type, self.reject_code, code=self.conf.STA_CODE.FAIL, hint='missing params,reject'))
             return
         ukey = self.get_ukey(uinfo)
@@ -219,10 +215,8 @@
 
 class WsProtocol(WebSocketProtocol):
 
     def connection_lost(self, exc):
         super(WsProtocol, self).connection_lost(exc)
         if (self.websocket is not None) and hasattr(self.websocket, 'uinfo'):
             loop = asyncio.get_running_loop()
-            loop.create_task(RdsWS.ws_manager.close_ws(self.websocket.uinfo))
-            for item in RdsWS.CMD_MAP.values():
-                hasattr(item, 'off_line') and loop.create_task(item.off_line(self.websocket.uinfo))
+            loop.create_task(RdsWS.ws_manager.call_offline(self.websocket.uinfo))
```

## msanic/libs/manager.py

```diff
@@ -2,14 +2,15 @@
 
 
 class WsConnector:
     """Websocket连接管理器"""
 
     _WS_MAP = {}
     conf = None
+    registers = {}
 
     @classmethod
     def set_conf(cls, conf):
         cls.conf = conf
 
     @classmethod
     def all_ws(cls):
@@ -35,14 +36,27 @@
         ws = cls.get_ws(key)
         if ws:
             cls._WS_MAP.pop(key)
             msg and await ws.send(msg)
             await ws.close()
         cls.conf and cls.conf.rds and await cls.conf.rds.drop_hash(cls.conf.WS_ONLINE_INFO, key)
 
+    @classmethod
+    def register_fun(cls, key: str, fun: 'callable'):
+        (key not in cls.registers) and cls.registers.update({key: fun})
+
+    @classmethod
+    async def call_offline(cls, ukey: Union[int, str]):
+        await cls.close_ws(ukey)
+        for fun in cls.registers.values():
+            try:
+                await fun(ukey)
+            except Exception as err:
+                cls.conf.log.error(f'用户掉线处理出错：{ukey}, {err}')
+
 
 class HeaderSet:
 
     RESP_TYPE = {
         'JSON': 'application/json',
         'MSGPACK': 'text/msgpack',
         'TEXT': 'text/plain',
```

## Comparing `msanic-1.0.21.dist-info/LICENSE` & `msanic-1.0.22.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `msanic-1.0.21.dist-info/METADATA` & `msanic-1.0.22.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: msanic
-Version: 1.0.21
+Version: 1.0.22
 Summary: A web framework who is use sanic + tortoise-orm + redis to quick create http&websocket server.
 Author: DHDONG
 Author-email: zscych@qq.com
 License: MIT
 Keywords: WebServer,Sanic,WebSite Develop,Web Framework
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
```

## Comparing `msanic-1.0.21.dist-info/RECORD` & `msanic-1.0.22.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -1,26 +1,26 @@
 msanic/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 msanic/base_blue.py,sha256=ZTQRdgkmmjhcSHMjXHj0gypj3QDu3uKMrZ-LetvkmT4,3462
 msanic/base_conf.py,sha256=6oH0jR4KZWimRoTApIq9LLXyd3tWhfk38BkFELC6-TQ,8536
 msanic/base_server.py,sha256=zqY89X4amLX-xIEr-jZliSTmVnAUH4amWCYwaTmJTSE,3241
-msanic/base_ws.py,sha256=oTGuHO4K_h12hsBpt_WDmcyK6pfNfD5DECWyHhpnPq4,9898
+msanic/base_ws.py,sha256=jCkyagGqVAQpV5odC9-Yrnh8xSoJPcJ04XcOIzv7Bto,9666
 msanic/exception.py,sha256=iz1kGBWkcYQ3zwUjreEjojQ9BLFkCabqRTe70ttgBUQ,2908
 msanic/handler_http.py,sha256=MgyJSiwHAPkCP_dVqLZGaDCrVnz86_utqpg7e1-9UGE,7677
 msanic/handler_ws.py,sha256=XWhzv_36FM71Ox8nuhr952b_PjWJeJihm3h8W6pq44M,2727
 msanic/middleware.py,sha256=YCgWTJlELPWWYdMbaHNUIgFFiKHQezMgko3b0g09m-A,576
 msanic/mult_creator.py,sha256=nMIW10dMn9VJvHdVqeCi-YLEN0UMY9y_JcuhxQw-r74,10352
 msanic/verify.py,sha256=JVpivos9g7uBE6a08jI4BfhhsqJMWE-71tdrh2awRwc,8531
 msanic/libs/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 msanic/libs/base_timed.py,sha256=IoPAOt_pRxA4_mQKOu_CMd1Mcu7ditijeKERTvzUZ0A,7656
 msanic/libs/component.py,sha256=21DIgD6RU6u36H2kuN0oA1uBdidULpYiZhpMqRX8hxk,1276
 msanic/libs/consts.py,sha256=OHIOgaLY8R8jZRiwDeEDg_3NN7kj-gZ_7HnP6Ccoq4c,3151
 msanic/libs/crypto.py,sha256=rCuzGGGYSZimdd8OhQCfIdZBUbBnX0FdPNO3sivy1L4,1578
 msanic/libs/decorator.py,sha256=SrQWbiYrUBE_0xHb9SF8-_KwUUqyRQvozQD3PIve_dM,3171
 msanic/libs/file_type.py,sha256=4OBdtXoNedXYpucs_99VdPfQw_Of6d8XFsRtTbGi8k0,1125
-msanic/libs/manager.py,sha256=N6szxUY8LvH8cSyjqeZSbOx6u9ajlXuYksxMctyt6rA,2235
+msanic/libs/manager.py,sha256=LzK5dio5dNmpRqIz6xJP9ai6nQQAh9_ySghTddGCEcA,2728
 msanic/libs/mult_log.py,sha256=wN-Wu2Q8byarCyu34mBmeBJUPIvmYZy6BVauifRoZDQ,2495
 msanic/libs/random_maker.py,sha256=-7ybIY0LrQ4eqvrCYc9kHBgnzqaEyRAYo57KOXKtRCA,5263
 msanic/libs/rds_client.py,sha256=QP9npHM0ixcBNEUf1lLmz85_ZJXzT-GDymzW2ZARWXQ,8453
 msanic/libs/rds_locker.py,sha256=Q8UkKAyHz4xdoG_oL0j5BfsBpTeKbW8sy7yDXwO62_E,1116
 msanic/libs/tool.py,sha256=7Bp0KkNMiuLnSATXccaBdW5Qz3FWaPykVNemfGu-Xb0,6985
 msanic/libs/tool_dt.py,sha256=ymTQBwxoUHigSX_L06LHDjzGBNmKjKXTLLAQBv_ssA8,5014
 msanic/libs/tool_jwt.py,sha256=cCdHNB16fp3MZfDT77ocUtHFtOrQjKu1qZL9x2iCI0A,3070
@@ -30,13 +30,13 @@
 msanic/orm/db_model.py,sha256=Gd9Zm7DjiEH4xGEqM19Iar-2tTMY5lziRfaBlWOBLZ0,18726
 msanic/orm/mssql_generator.py,sha256=c9q71hljWqBxoNriG0OefwD48w3gVTb62HnFKjreom4,11698
 msanic/orm/mysql_generator.py,sha256=6AMVa9twa7GRCuTlEga5g2zHJvkCD9YocUwGGcvLQ4Q,11743
 msanic/orm/pgsql_generator.py,sha256=BMNDAZ-2X9dPbUOBlhR5UJBfqXWpl23KRgTozleKCCQ,11720
 msanic/orm/rc_model.py,sha256=NcgSVW34eSx_TiMYE9DYrA6Bt_qitTRH5pX3UYqa6ok,5098
 test/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 test/test_unit.py,sha256=zIZWr20nXYmLsKZpGZv-dmRuwQTJXyTcAcUDbx3FdF0,701
-msanic-1.0.21.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
-msanic-1.0.21.dist-info/METADATA,sha256=07B8AtzQkIpLiKvk49S6CVO0MLZ2r8o8PA9ZwQhdIHw,4801
-msanic-1.0.21.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-msanic-1.0.21.dist-info/entry_points.txt,sha256=CAoZ_qtmP0HhzVmX9w0oN-KSxoCpdqxjDC4pljoU-l4,52
-msanic-1.0.21.dist-info/top_level.txt,sha256=lT96LXfr87NYrx1PR9GraMGNX9KQ6ImvR88MTHEhBkM,12
-msanic-1.0.21.dist-info/RECORD,,
+msanic-1.0.22.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
+msanic-1.0.22.dist-info/METADATA,sha256=86I-CdWedwgC0KTmBcslF5XEhR2CiEnYk8Ytp-rHb4M,4801
+msanic-1.0.22.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+msanic-1.0.22.dist-info/entry_points.txt,sha256=CAoZ_qtmP0HhzVmX9w0oN-KSxoCpdqxjDC4pljoU-l4,52
+msanic-1.0.22.dist-info/top_level.txt,sha256=lT96LXfr87NYrx1PR9GraMGNX9KQ6ImvR88MTHEhBkM,12
+msanic-1.0.22.dist-info/RECORD,,
```

